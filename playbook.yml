---
- name: Déploiement projet LAMP
  hosts: all
  become: yes

  vars:
    project_git_url: "https://gitlab.com/Vincent-Antoine/trygl.git"
    web_root: "/var/www/html/trygl"
    apache_root: "{{ web_root }}/src"          # <- pointe sur src maintenant
    apache_conf_path: "/etc/httpd/conf/httpd.conf"

  tasks:
    - name: Créer utilisateur ynov
      user:
        name: ynov
        state: present
        shell: /bin/bash
        create_home: yes

    - name: Installer la stack complète LAMP
      dnf:
        name:
          - httpd
          - mariadb105-server
          - php
          - php-mysqlnd
          - php-cli
          - php-json
          - php-common
          - unzip
          - git
        state: present
        update_cache: yes

    - name: Supprimer le contenu de {{ web_root }}
      file:
        path: "{{ web_root }}"
        state: absent

    - name: Cloner le dépôt Git dans {{ web_root }}
      git:
        repo: "{{ project_git_url }}"
        dest: "{{ web_root }}"
        version: main
        force: yes

    - name: Télécharger Composer
      get_url:
        url: https://getcomposer.org/installer
        dest: /tmp/composer-setup.php

    - name: Installer Composer globalement
      command: php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer
      args:
        creates: /usr/local/bin/composer

    - name: Installer les dépendances PHP si composer.json existe
      stat:
        path: "{{ apache_root }}/composer.json"
      register: composer_json

    - name: Run composer install
      command: /usr/local/bin/composer install --no-interaction
      args:
        chdir: "{{ apache_root }}"
      when: composer_json.stat.exists

    - name: Modifier le DocumentRoot dans la conf Apache
      replace:
        path: "{{ apache_conf_path }}"
        regexp: '^\s*DocumentRoot\s+".*"'
        replace: 'DocumentRoot "{{ apache_root }}"'

    - name: Ajouter configuration Directory pour Apache
      blockinfile:
        path: "{{ apache_conf_path }}"
        insertafter: '^DocumentRoot'
        block: |
          <Directory "{{ apache_root }}">
              AllowOverride None
              Require all granted
          </Directory>

    - name: Donner les droits à Apache sur {{ apache_root }}
      file:
        path: "{{ apache_root }}"
        state: directory
        recurse: yes
        owner: apache
        group: apache
        mode: "0755"

    - name: Redémarrer Apache
      service:
        name: httpd
        state: restarted

    - name: Vérifier le healthcheck
      uri:
        url: http://localhost/
        return_content: yes
        status_code: 200
