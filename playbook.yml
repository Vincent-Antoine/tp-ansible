---
- name: Déploiement projet LAMP
  hosts: all
  become: yes

  tasks:
    - name: Créer l’utilisateur ynov
      user:
        name: ynov
        shell: /bin/bash
        create_home: yes

    - name: Installer Apache, MariaDB, PHP, Git et unzip
      dnf:
        name:
          - httpd
          - mariadb105-server
          - php
          - php-mysqlnd
          - php-cli
          - git
          - unzip
        state: present
        update_cache: yes

    - name: Supprimer l’ancienne application
      file:
        path: /var/www/html/trygl
        state: absent

    - name: Cloner le dépôt GitLab dans /var/www/html/trygl
      git:
        repo: https://gitlab.com/Vincent-Antoine/trygl.git
        dest: /var/www/html/trygl
        version: main
        force: yes

    - name: Télécharger l’installateur Composer
      get_url:
        url: https://getcomposer.org/installer
        dest: /tmp/composer-setup.php

    - name: Installer Composer
      command: php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer
      args:
        creates: /usr/local/bin/composer

    - name: Installer les dépendances PHP avec Composer
      command: /usr/local/bin/composer install --no-interaction
      args:
        chdir: /var/www/html/trygl/src

    - name: Vérifier la syntaxe Apache avant redémarrage
      command: apachectl configtest
      register: apache_syntax
      changed_when: false
      failed_when: apache_syntax.rc != 0

    - name: Mettre à jour le DocumentRoot pour pointer sur src
      replace:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^\s*DocumentRoot\s+".*"'
        replace: 'DocumentRoot "/var/www/html/trygl/src"'

    - name: Autoriser l’accès au répertoire de l’application
      blockinfile:
        path: /etc/httpd/conf/httpd.conf
        insertafter: '^DocumentRoot'
        block: |
          <Directory "/var/www/html/trygl/src">
            AllowOverride None
            Require all granted
          </Directory>

    - name: Redémarrer Apache
      service:
        name: httpd
        state: restarted

    - name: Vérifier que l’application répond bien
      uri:
        url: http://localhost/
        status_code: 200
